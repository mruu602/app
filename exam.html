<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>試験ページ</title>
<style>
body {
    font-family: sans-serif;
    margin: 0;
    padding-top: 160px;
    background: #f8f8f8;
}
header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: #fff;
    border-bottom: 1px solid #ccc;
    z-index: 1000;
    padding: 10px 10px 5px 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
header h2 { margin: 0; font-size:1.1em; }
header .timer { font-weight:bold; font-size:1em; margin-top:5px; }
#progress-container { position: relative; margin-top:5px; width:100%; background:#eee; height:20px; border-radius:10px; }
#progress-bar { height:100%; width:0%; background:#88f; border-radius:10px; transition: width 0.3s; }
#progress-text { position: absolute; left: 5px; top:0; height:100%; line-height:20px; font-size:0.9em; font-weight:bold; color:#fff; }
#nav-container {
    margin-top:8px;
    overflow-x:auto;
    white-space:nowrap;
    padding-bottom:5px;
}
.nav-btn {
    display:inline-block;
    min-width:30px;
    height:30px;
    line-height:30px;
    text-align:center;
    margin:2px;
    border:1px solid #666;
    border-radius:50%;
    cursor:pointer;
    font-size:0.9em;
    transition: all 0.2s;
}
.nav-btn.answered { background-color:#8f8; }
.nav-btn.unanswered { background-color:#fff; }
.nav-btn.current { border:2px solid #00f; background-color:#88f; color:#fff; }
.nav-btn:hover { transform: scale(1.1); }

/* 問題カードを中央表示 */
.question-card {
    display: block;
    margin: 20px auto;
    max-width: 800px;
    width: 90%;
    border:1px solid #ccc;
    padding:20px;
    border-radius:8px;
    background:#fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    word-break: break-word;
}

/* 問題文 */
.question-text {
    white-space: pre-wrap;
    line-height: 1.6;
    text-align: left;
    text-indent: 1em; /* 最初の行だけインデント */
    margin-bottom: 15px;
}

/* 選択肢 */
.choices {
    display: flex;
    flex-direction: column;
    margin-top: 5px;
}

/* 選択肢ラベル */
.choices label {
    display:flex;
    align-items:center;
    margin:6px 0 6px 1em; /* 左に自然な余白 */
    font-size:1em;
    padding:6px 8px;
    border-radius:4px;
    cursor:pointer;
    transition: background 0.2s;
    user-select: none;
}

/* ホバー時 */
.choices label:hover { background:#f0f0f0; }

/* ラジオボタン */
.choices label input[type="radio"] {
    margin-right:8px;
    margin-top:0;
    vertical-align: middle;
    flex-shrink:0;
}

/* 選択済みラベルハイライト */
.choices label.selected { background-color:#ddf; }

.question-image {
    text-align: center;
    margin: 10px 0;
}
.question-image img {
    max-width: 100%;
    height: auto;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.result-box {
    margin-top:5px;
    padding:5px;
    border-radius:3px;
    font-size:0.9em;
}
.result-ok { background-color:#cfc; }
.result-ng { background-color:#fcc; }

button {
    font-size:1em;
    padding:8px 15px;
    margin:5px;
    border-radius:5px;
    border:1px solid #666;
    cursor:pointer;
}
button:hover { background:#eee; }

#submit-container {
    margin:10px auto;
    text-align:center;
}

/* スマホ対応 */
@media (max-width: 480px) {
    body { padding-top: 160px; }
    .question-card { 
        padding:10px; 
        margin:10px auto; 
        max-width: 95vw;
        width: 95%;
    }
    .question-text { text-indent: 0.8em; margin-bottom:12px; }
    .choices label { font-size:0.95em; padding:6px 6px; margin-left:0.8em; }
    .nav-btn { min-width:25px; height:25px; line-height:25px; font-size:0.8em; }
    button { padding:6px 12px; font-size:0.95em; }
    #progress-text { font-size:0.8em; }
}
</style>
</head>
<body>

<header>
    <h2>試験 / 学習モード: <span id="mode">{{ mode }}</span></h2>
    <div class="timer">残り時間: <span id="timer">--:--</span></div>
    <div id="progress-container">
        <div id="progress-bar"></div>
        <div id="progress-text">0 / 0</div>
    </div>
    <div id="nav-container"></div>
</header>

<div id="questions-container"></div>

<div id="submit-container">
    <button onclick="submitExam()">提出</button>
</div>

<script>
let questions = [];
let answers = {};
let submitted = false;
let remainingSeconds = {{ remaining_seconds if remaining_seconds is not none else 'null' }};
let currentIndex = 0;
let examMode = "{{ mode }}";
const storageKey = `exam_{{ exam_id }}_answers`;

document.addEventListener("DOMContentLoaded", loadQuestions);

function escapeQuotes(str){ return str ? str.replace(/'/g,"\\'").replace(/"/g,'\\"') : ""; }
function renderTextWithImages(text){
    if(!text) return "";
    const cleaned = text.replace(/^[ \t　]+/gm, "");
    return cleaned.replace(/\[img:(https?:\/\/[^\]\s]+)\]/g,'<div class="question-image"><img src="$1"></div>');
}
function saveAnswers(){ localStorage.setItem(storageKey, JSON.stringify(answers)); }
function loadSavedAnswers(){ const saved = localStorage.getItem(storageKey); if(saved) answers = JSON.parse(saved); }

function loadQuestions(){
    loadSavedAnswers();
    fetch(`/load_questions?exam_id={{ exam_id }}&student_name={{ student_name }}`)
    .then(res=>res.json())
    .then(data=>{
        questions = data.questions;
        examMode = data.mode || "exam";

        if(questions.length === 0){
            alert("問題が見つかりません。管理者で問題を登録してください。");
            return;
        }

        currentIndex = 0;
        createNav();
        renderQuestion();
        updateProgress();
        highlightNav();

        if(examMode==="exam" && remainingSeconds != null) startTimer();
    });
}

function renderQuestion(){
    const c = document.getElementById("questions-container");
    c.innerHTML="";
    if(!questions[currentIndex]) return;
    const q = questions[currentIndex];

    let div = document.createElement("div");
    div.className="question-card current-card";
    div.id = `question-${q.id}`;
    div.innerHTML = `
        <div class="question-text">
            ${currentIndex+1}. ${renderTextWithImages(q.question_text)}
        </div>
        <div class="choices" id="choices${q.id}"></div>
        <div id="result${q.id}"></div>
        <div style="text-align:center;margin-top:10px;">
            ${currentIndex>0?'<button onclick="prevQuestion()">前へ</button>':''}
            ${currentIndex<questions.length-1?'<button onclick="nextQuestion()">次へ</button>':''}
        </div>
    `;
    c.appendChild(div);

    const choices = div.querySelector(`#choices${q.id}`);
    q.choices.forEach(cval=>{
        const esc = escapeQuotes(cval);
        const checked = answers[q.id] === cval ? "checked" : "";
        choices.innerHTML += `
        <label>
            <input type="radio" name="q${q.id}" value="${esc}" ${checked} onclick="record(${q.id}, '${esc}')">
            ${renderTextWithImages(cval)}
        </label>`;
    });

    updateSelectedLabel(q.id);
    if(q.id in answers && examMode==="study"){
        showResult(q.id, answers[q.id]);
    }

    highlightNav();
    updateProgress();
    div.scrollIntoView({behavior:"smooth", block:"start"});
}

function updateSelectedLabel(qid){
    const choices = document.querySelectorAll(`#choices${qid} label`);
    choices.forEach(label=>{
        const input = label.querySelector("input[type=radio]");
        if(input.checked){ label.classList.add("selected"); }
        else{ label.classList.remove("selected"); }
    });
}

function record(qid,val){
    qid=parseInt(qid);
    answers[qid]=val;
    saveAnswers();
    updateSelectedLabel(qid);
    updateProgress();
    highlightNav();
    if(examMode==="study"){ showResult(qid,val); }
}

function showResult(qid,val){
    fetch("/check_answer",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({exam_id: {{ exam_id }}, question_id: qid, selected_answer: val})
    }).then(res=>res.json())
    .then(data=>{
        const box = document.getElementById(`result${qid}`);
        if(data.is_correct){
            box.innerHTML=`<div class="result-box result-ok">⭕ 正解</div>`;
        }else{
            box.innerHTML=`<div class="result-box result-ng">❌ 不正解（正答：${data.correct_answer}）</div>`;
        }
    });
}

function nextQuestion(){ if(currentIndex<questions.length-1) currentIndex++; renderQuestion(); }
function prevQuestion(){ if(currentIndex>0) currentIndex--; renderQuestion(); }

function createNav(){
    const nav = document.getElementById("nav-container");
    nav.innerHTML="";
    questions.forEach((q,i)=>{
        const b = document.createElement("span");
        b.className="nav-btn unanswered";
        b.dataset.qid=q.id;
        b.textContent=i+1;
        b.onclick=()=>{ currentIndex=i; renderQuestion(); };
        nav.appendChild(b);
    });
}

function highlightNav(){
    const btns = document.getElementsByClassName("nav-btn");
    for(let i=0;i<btns.length;i++){
        const qid = parseInt(btns[i].dataset.qid);
        const isAnswered = qid in answers;
        btns[i].classList.toggle("answered", isAnswered);
        btns[i].classList.toggle("unanswered", !isAnswered);
        btns[i].classList.toggle("current", i===currentIndex);
    }
}

function updateProgress(){
    const cnt = Object.values(answers).filter(v=>v).length;
    document.getElementById("progress-text").innerText=`${cnt} / ${questions.length}`;
    document.getElementById("progress-bar").style.width=(cnt/questions.length*100)+"%";
}

function submitExam(auto=false){
    if(submitted) return;
    if(!auto && examMode==="exam" && !confirm("途中提出しますか？")) return;
    submitted=true;

    fetch("/submit_exam",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            student_name:"{{ student_name }}",
            exam_id:{{ exam_id }},
            answers:answers
        })
    }).then(()=>{
        localStorage.removeItem(storageKey);
        location.href=`/result?student_name={{ student_name }}&exam_id={{ exam_id }}&mode=${examMode}`;
    });
}

function startTimer(){
    if(examMode!=="exam" || remainingSeconds==null) return;
    const t = document.getElementById("timer");
    const timerId = setInterval(()=>{
        remainingSeconds--;
        if(remainingSeconds<=0){
            clearInterval(timerId);
            alert("時間切れです。自動提出します。");
            submitExam(true);
        }
        t.innerText=`残り時間 ${Math.floor(remainingSeconds/60)}:${String(remainingSeconds%60).padStart(2,"0")}`;
    },1000);
}
</script>

</body>
</html>
